var webtermCommunicator="/php/webtermCom.php";function WebTerm(a,b,d){this.prefix=a+"@"+b;this.tryPath=d;this.currentPath="~";this.previousPath=d;this.home=d;this.history=[];this.historyPtr=0;this.editorEnabled=false;this.editorFile=null;var c=this;$("#webtermJS").append("<textarea id='webtermContent' disabled></textarea>");$("#webtermJS").append("<form>"+printPrefix(this)+"<input autocomplete='off' id='webtermJScommand' type='text'/></form>");$("#webtermJScommand").parent().submit(function(e){e.preventDefault();issueCommand(c,$("#webtermJScommand").val())});$("#webtermJScommand").keydown(function(e){exploreHistory(c,e)})}function printPrefix(a){return"<span class='webtermJSprefix'>"+a.prefix+"</span>:<span class='webtermJSpath'>"+resolvePath(a)+"</span>$ "}function printPrefixOut(a){return a.prefix+":"+resolvePath(a)+"$ "}function updatePrefixPath(a){$(".webtermJSpath").text(resolvePath(a))}function exploreHistory(a,b){var c;if(b.which==38){b.preventDefault();c=a.history[a.historyPtr];$("#webtermJScommand").val(c);if(a.historyPtr>0){a.historyPtr--}}else{if(b.which==40){b.preventDefault();c=a.history[a.historyPtr];$("#webtermJScommand").val(c);if(a.historyPtr+1<a.history.length){a.historyPtr++}else{if(a.historyPtr+1==a.history.length){$("#webtermJScommand").val("")}}}}}function resolvePath(c){var d=c.tryPath;if(d=="."){return c.currentPath}if(c.currentPath===c.home||d===c.home){return"~"}if(c.currentPath==="~"){return c.home}if(d==="/.."){return"/"}var b=d;if(b.charAt(0)!="/"){d=c.currentPath+c.tryPath}if(b===".."){var a=c.tryPath.substr(0,c.tryPath.lastIndexOf("/"));d=a.substr(0,a.lastIndexOf("/")+1)}if(b==="-"){d=c.previousPath}if(b.charAt(0)=="~"){d=c.home+c.tryPath}return d}function issueCommand(b,d){if(!b.editorEnabled){$("#webtermContent").val($("#webtermContent").val()+printPrefixOut(b)+d+"\n");$("#webtermContent").animate({scrollTop:$("#webtermContent").prop("scrollHeight")},300);if(d.length===0){return}var a=d.split(" ");b.history.push(d);b.historyPtr=b.history.length-1;if(commandCanBeSolvedImmediately(b,a)){if(a[0]!="!"){$("#webtermJScommand").val("")}$("#webtermContent").animate({scrollTop:$("#webtermContent").prop("scrollHeight")},300);return}b.tryPath=b.currentPath;$.post(webtermCommunicator,{path:resolvePath(b),command:a},function(f,e){f=JSON.parse(f);if(f.response!=null){$("#webtermContent").val($("#webtermContent").val()+f.response)}b.previousPath=b.currentPath;b.tryPath=f.path;b.currentPath=f.path;b.currentPath=resolvePath(b);updatePrefixPath(b);$("#webtermContent").animate({scrollTop:$("#webtermContent").prop("scrollHeight")},300)})}else{if(d.length===0){return}var c=d.split(" ");resolveEditorCommand(b,c)}$("#webtermJScommand").val("")}function commandCanBeSolvedImmediately(d,a){var b=false;switch(a[0]){case"clear":$("#webtermContent").val("");b=true;break;case"history":var e="";for(var c=0;c<d.history.length;c++){e=e+"\n"+c+"\t"+d.history[c]}$("#webtermContent").append(e+"\n");b=true;break;case"!":if(a[1]>d.history.length-1){a[1]=d.history.length-1}$("#webtermJScommand").val(d.history[a[1]]);b=true;break;case"mcedit":openEditor(d,a);b=true;break;case"vi":openEditor(d,a);b=true;break;case"vim":openEditor(d,a);b=true;break;case"edit":openEditor(d,a);b=true;break;case"nano":openEditor(d,a);b=true;break}return b}function openEditor(b,a){b.editorEnabled=true;b.editorFile=a[1];a[0]="###CREATEFILE~";b.tryPath=b.currentPath;$.post(webtermCommunicator,{path:resolvePath(b),command:a},function(d,c){d=JSON.parse(d);$("#webtermContent").val(d.response);$("#webtermContent").prop("disabled",false)})}function resolveEditorCommand(b,a){switch(a[0]){case":q!":closeEditor(b);break;case":q":closeEditor(b);break;case":w":saveFile(b,a);break;case":wq":saveAndCloseFile(b,a);break;default:$("#webtermJScommand").val("Unknown command");break}}function closeEditor(a){$("#webtermContent").val("");a.editorEnabled=false}function saveFile(b,a){a[0]="###SAVEFILE~";a[1]=resolvePath(b)+b.editorFile;a[2]=$("#webtermContent").val();$.post(webtermCommunicator,{path:resolvePath(b),command:a},function(d,c){$("#webtermJScommand").val("File saved!")})}function saveAndCloseFile(b,a){a[0]="###SAVEFILE~";a[1]=resolvePath(b)+b.editorFile;a[2]=$("#webtermContent").val();$.post(webtermCommunicator,{path:resolvePath(b),command:a},function(d,c){closeEditor(b,a)})};